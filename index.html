<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .semester-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .semester-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .danger-zone { border-left: 4px solid #ef4444; }
        .safe-zone { border-left: 4px solid #22c55e; }
        .warning-zone { border-left: 4px solid #f97316; }

        /* Calendar Styles */
        .calendar-day { cursor: pointer; transition: background-color 0.2s ease; border-radius: 50%; width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; }
        .calendar-day:hover:not(.outside-range) { background-color: #f3f4f6; }
        .calendar-day.present { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .calendar-day.absent { background-color: #fee2e2; color: #991b1b; font-weight: bold; }
        .calendar-day.holiday { background-color: #e5e7eb; color: #4b5563; }
        .calendar-day.outside-range { color: #d1d5db; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Semester Attendance Tracker</h1>
            <p class="text-gray-600 mt-2">Track your daily attendance for each semester.</p>
        </header>

        <!-- Controls Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-3">Add New Semester</h2>
            <form id="add-semester-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="semester-name" placeholder="e.g., Fall 2025" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                 <input type="number" id="attendance-req" min="1" max="100" value="75" placeholder="Attendance Goal (%)" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Attendance Goal (%)">
                <div>
                    <label for="semester-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="semester-start-date" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="semester-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="semester-end-date" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="md:col-span-2">
                     <button type="submit" class="btn w-full bg-indigo-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-indigo-700">Add Semester</button>
                </div>
            </form>
        </div>

        <!-- Semesters List -->
        <main id="semesters-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Semester cards will be injected here -->
        </main>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No semesters</h3>
            <p class="mt-1 text-sm text-gray-500">Get started by adding a new semester above.</p>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="calendar-title" class="text-2xl font-bold">Calendar</h2>
                <button id="close-calendar" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">&lt;</button>
                    <h3 id="month-year" class="text-xl font-semibold"></h3>
                    <button id="next-month" class="btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">&gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-y-2 place-items-center text-center">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addSemesterForm = document.getElementById('add-semester-form');
            const semesterNameInput = document.getElementById('semester-name');
            const attendanceReqInput = document.getElementById('attendance-req');
            const startDateInput = document.getElementById('semester-start-date');
            const endDateInput = document.getElementById('semester-end-date');
            const semestersList = document.getElementById('semesters-list');
            const emptyState = document.getElementById('empty-state');
            
            const calendarModal = document.getElementById('calendar-modal');
            const calendarTitle = document.getElementById('calendar-title');
            const closeCalendarBtn = document.getElementById('close-calendar');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const monthYearDisplay = document.getElementById('month-year');
            const calendarGrid = document.getElementById('calendar-grid');

            let semesters = JSON.parse(localStorage.getItem('attendance_semesters_v3')) || [];
            let attendanceReq = localStorage.getItem('attendance_req') || 75;
            attendanceReqInput.value = attendanceReq;
            let activeCalendar = { semesterId: null, date: new Date() };

            const saveData = () => {
                localStorage.setItem('attendance_semesters_v3', JSON.stringify(semesters));
                localStorage.setItem('attendance_req', attendanceReq);
            };

            const renderSemesters = () => {
                semestersList.innerHTML = '';
                emptyState.classList.toggle('hidden', semesters.length > 0);
                
                semesters.forEach(semester => {
                    const totalWorkingDays = semester.present + semester.absent;
                    const percentage = totalWorkingDays === 0 ? 0 : ((semester.present / totalWorkingDays) * 100);
                    
                    let statusClass = 'safe-zone';
                    let statusText = `Above ${attendanceReq}% goal. Well done!`;

                    if (percentage < attendanceReq && totalWorkingDays > 0) {
                        const daysToAttend = Math.ceil(((attendanceReq/100) * totalWorkingDays - semester.present) / (1 - (attendanceReq/100)));
                        statusClass = 'danger-zone';
                        statusText = `Attend the next ${daysToAttend} day(s) to meet your goal.`;
                    } else if (percentage >= attendanceReq && totalWorkingDays > 0) {
                        const canMiss = Math.floor((semester.present * 100 / attendanceReq) - totalWorkingDays);
                        statusText = canMiss > 0 ? `You can miss the next ${canMiss} day(s).` : `You're on track. Don't miss the next working day!`;
                    }
                    const semStartDate = new Date(semester.startDate);
                    const semEndDate = new Date(semester.endDate);
                    const totalSemesterDays = Math.round((semEndDate - semStartDate) / (1000 * 60 * 60 * 24)) + 1;
                    const markedDays = Object.keys(semester.dates).length;
                    const unmarkedDays = totalSemesterDays > markedDays ? totalSemesterDays - markedDays : 0;

                    const card = document.createElement('div');
                    card.className = `semester-card bg-white p-5 rounded-lg shadow-md ${statusClass}`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">${semester.name}</h3>
                                <p class="text-xs text-gray-500">${new Date(semester.startDate).toLocaleDateString('en-CA')} to ${new Date(semester.endDate).toLocaleDateString('en-CA')}</p>
                            </div>
                            <button class="text-lg font-bold text-gray-400 hover:text-red-500" onclick="deleteSemester(${semester.id})">&times;</button>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-lg font-semibold text-indigo-600">${percentage.toFixed(1)}%</span>
                                <span class="text-sm text-gray-500">${semester.present} / ${totalWorkingDays} days</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                            <p class="text-xs text-gray-500 mt-2">${statusText}</p>
                        </div>
                        <div class="mt-4 grid grid-cols-2 divide-x divide-gray-200 text-center">
                            <div class="pr-2">
                                <span class="text-lg font-bold text-gray-800">${totalSemesterDays}</span>
                                <span class="text-sm text-gray-600 block">Total Days</span>
                            </div>
                             <div class="pl-2">
                                <span class="text-lg font-bold text-gray-800">${unmarkedDays}</span>
                                <span class="text-sm text-gray-600 block">Days Remaining</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t grid grid-cols-3 gap-4 text-center">
                           <div>
                                <label class="text-sm text-green-600 font-semibold">Present</label>
                                <input type="number" min="0" value="${semester.present}" onchange="updateCount(${semester.id}, 'present', this.value)" class="w-full mt-1 p-2 border rounded-md text-center">
                           </div>
                           <div>
                                <label class="text-sm text-red-600 font-semibold">Absent</label>
                                <input type="number" min="0" value="${semester.absent}" onchange="updateCount(${semester.id}, 'absent', this.value)" class="w-full mt-1 p-2 border rounded-md text-center">
                           </div>
                           <div>
                                <label class="text-sm text-gray-600 font-semibold">Holidays</label>
                                <input type="number" min="0" value="${semester.holidays}" onchange="updateCount(${semester.id}, 'holidays', this.value)" class="w-full mt-1 p-2 border rounded-md text-center">
                           </div>
                        </div>
                        <div class="mt-6">
                            <button class="btn w-full bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-600" onclick="openCalendar(${semester.id})">View Calendar</button>
                        </div>
                    `;
                    semestersList.appendChild(card);
                });
            };

            addSemesterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = semesterNameInput.value.trim();
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                if (name && startDate && endDate) {
                    if (new Date(endDate) < new Date(startDate)) {
                        alert("End date cannot be before the start date.");
                        return;
                    }
                    const newSemester = { id: Date.now(), name, startDate, endDate, present: 0, absent: 0, holidays: 0, dates: {} };
                    autoMarkWeekends(newSemester);
                    semesters.push(newSemester);
                    recalculateTotals(newSemester.id);
                    saveData();
                    renderSemesters();
                    addSemesterForm.reset();
                    attendanceReqInput.value = localStorage.getItem('attendance_req') || 75;
                }
            });

            attendanceReqInput.addEventListener('change', (e) => {
                attendanceReq = parseInt(e.target.value) || 75;
                saveData();
                renderSemesters();
            });

            const autoMarkWeekends = (semester) => {
                let currentDate = new Date(semester.startDate + "T00:00:00");
                const lastDate = new Date(semester.endDate + "T00:00:00");
                
                while(currentDate <= lastDate) {
                    const dayOfWeek = currentDate.getDay();
                    if(dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                        const dateStr = currentDate.toISOString().slice(0,10);
                        semester.dates[dateStr] = 'holiday';
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            };

            window.deleteSemester = (id) => {
                if (confirm('Are you sure you want to delete this semester?')) {
                    semesters = semesters.filter(s => s.id !== id);
                    saveData();
                    renderSemesters();
                }
            };
            
            window.updateCount = (id, type, value) => {
                const semester = semesters.find(s => s.id === id);
                const numValue = parseInt(value);
                if (semester && !isNaN(numValue)) {
                    semester[type] = numValue;
                    saveData();
                    renderSemesters();
                }
            };

            window.openCalendar = (id) => {
                activeCalendar.semesterId = id;
                const semester = semesters.find(s => s.id === id);
                activeCalendar.date = new Date(semester.startDate);
                calendarTitle.textContent = `${semester.name} - Calendar`;
                renderCalendar();
                calendarModal.classList.remove('hidden');
            };

            const renderCalendar = () => {
                const semester = semesters.find(s => s.id === activeCalendar.semesterId);
                if (!semester) return;
                
                const semStartDate = new Date(semester.startDate + "T00:00:00");
                const semEndDate = new Date(semester.endDate + "T00:00:00");
                const year = activeCalendar.date.getFullYear();
                const month = activeCalendar.date.getMonth();
                monthYearDisplay.textContent = `${activeCalendar.date.toLocaleString('default', { month: 'long' })} ${year}`;
                
                calendarGrid.innerHTML = '';
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    dayEl.className = 'font-bold text-gray-600';
                    calendarGrid.appendChild(dayEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.appendChild(document.createElement('div'));
                
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = i;
                    const currentDate = new Date(year, month, i);
                    const dateStr = currentDate.toISOString().slice(0,10);
                    
                    dayEl.className = 'calendar-day';
                    
                    if (currentDate < semStartDate || currentDate > semEndDate) {
                        dayEl.classList.add('outside-range');
                    } else {
                        const status = semester.dates[dateStr];
                        if (status) dayEl.classList.add(status);
                        dayEl.addEventListener('click', () => handleDayClick(dateStr));
                    }
                    calendarGrid.appendChild(dayEl);
                }
            };

            const handleDayClick = (dateStr) => {
                const semester = semesters.find(s => s.id === activeCalendar.semesterId);
                if (!semester) return;
                
                const currentStatus = semester.dates[dateStr];
                const nextStatus = { undefined: 'present', 'present': 'absent', 'absent': 'holiday', 'holiday': undefined }[currentStatus];

                if (nextStatus) semester.dates[dateStr] = nextStatus;
                else delete semester.dates[dateStr];
                
                recalculateTotals(activeCalendar.semesterId);
                saveData();
                renderCalendar(); 
                renderSemesters(); 
            };
            
            const recalculateTotals = (id) => {
                const semester = semesters.find(s => s.id === id);
                if(!semester) return;
                
                let present = 0, absent = 0, holidays = 0;
                for(const date in semester.dates) {
                    if (semester.dates[date] === 'present') present++;
                    else if (semester.dates[date] === 'absent') absent++;
                    else if (semester.dates[date] === 'holiday') holidays++;
                }
                semester.present = present;
                semester.absent = absent;
                semester.holidays = holidays;
            };

            closeCalendarBtn.addEventListener('click', () => calendarModal.classList.add('hidden'));

            prevMonthBtn.addEventListener('click', () => {
                activeCalendar.date.setMonth(activeCalendar.date.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                activeCalendar.date.setMonth(activeCalendar.date.getMonth() + 1);
                renderCalendar();
            });

            renderSemesters();
        });
    </script>
</body>
</html>

